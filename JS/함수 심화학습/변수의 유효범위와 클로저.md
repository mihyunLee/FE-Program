# 변수의 유효범위와 클로저



> 출처 - [**모던 JS 튜토리얼**](https://ko.javascript.info/)을 보고 정리한 글입니다.



<br>



## 1. 코드 블록

- 코드 블록 `{...}` 안에서 선언한 변수는 블록 안에서만 사용할 수 있다.

<br>

## 2. 중첩 함수

함수 내부에서 선언한 함수를 **중첩 함수**라고 한다.

중첩 함수는 코드를 정돈하는데 사용할 수 있다.

```javascript
function sayHiBye(firstName, lastName) {

  // 헬퍼(helper) 중첩 함수
  function getFullName() {
    return firstName + " " + lastName;
  }

  alert( "Hello, " + getFullName() );
  alert( "Bye, " + getFullName() );

}
```

<br>

## 3. 렉시컬 환경

### 1 ) 변수

자바스크립트에선 실행 중인 함수, 코드 블록, 스크립트 전체는 **렉시컬 환경**(Lexical Environment) 이라 불리는 **내부 숨김 연관 객체**(internal idden associated object)를 갖는다.

> 렉시컬 환경 객체 구성요소

1. `환경 레코드(Environment Record)` - 모든 지역 변수를 프로퍼티로 저장하고 있는 객체, `this` 값과 같은 기타 정보도 여기에 저장한다.
2. `외부 렉시컬 환경(Outer Lexical Environment)에 대한 참조` - 외부 코드와 연관된다.

변수는 특수 내부 객체인 `환경 레코드`의 프로퍼티로, 변수를 가져오거나 변경하는 것은 환경 레코드의 프로퍼티를 가져오거나 변경하는 것을 의미한다.

![image-20220821182410055](https://user-images.githubusercontent.com/51310674/185786628-15510626-b3fc-4ea1-a009-e0fe06946c23.png)

- 스크립트 전체와 관련된 렉시컬 환경은 **전역 렉시컬 환경**이라고 하는데, 위 코드에서는 렉시컬 환경이 하나만 존재한다.
- `네모 상자` - 변수가 저장되는 환경 레코드
- `화살표` - 외부 렉시컬 환경에 대한 참조
- 전역 렉시컬 환경은 외부 참조를 갖지 않기 때문에 화살표가 `null` 을 가리킨다.

![image-20220821182732446](https://user-images.githubusercontent.com/51310674/185786631-ce4837e5-0c98-4f8e-8b6e-70e9de8ff0d3.png)

- 스크립트가 시작되면 스크립트 내에서 선언한 변수 전체가 렉시컬 환경에 올라간다. (pre-populated)
  - 이 때 변수의 상태는 특수 내부 상태인 `uninitialized`가 되고, 자바스크립트 엔진은 `let`을 만나기 전까진 이 변수를 참조할 수 없다.
- `let phrase`를 만나면서 프로퍼티 값은 `undefined`가 된다.
- `phrase = "Hello";`에서 값이 할당되었다.
- `phrase = "Bye";`에서 값이 변경되었다.

<br>

### 2) 함수 선언문

- 함수는 변수와 마찬가지로 값이다.
- 함수 선언문으로 선언한 함수는 일반 변수와는 달리 바로 **초기화**된다.
- 함수 선언문으로 선언한 함수는 렉시컬 환경이 만들어지는 즉시 사용할 수 있다.
  - 따라서, 선언되기 전에도 함수를 사용할 수 있는 것
  - 함수를 변수에 할당한 함수 표현식은 해당하지 않는다.

<br>

### 3) 내부와 외부 렉시컬 환경

- 함수를 호출해 실행하면 **새로운 렉시컬 환경**이 자동으로 만들어지고, 이 렉시컬 환경엔 함수 호출 시 넘겨받은 매개변수와 함수의 지역 변수가 저장된다.
- 함수가 호출 중인 동안엔 호출 중인 함수를 위한 `내부 랙시컬 환경`과 내부 렉시컬 환경이 가리키는 `외부 렉시컬 환경`을 갖는다. => 내부 렉시컬 환경은 `외부` 렉시컬 환경에 대한 참조를 갖는다.
  - **내부 렉시컬 함수**엔 함수의 인자로부터 유래한 프로퍼티가 존재한다.
  - **외부 렉시컬 환경**은 전역 렉시컬 환경이다.

- 코드에서 변수에 접근할 땐, 내부 렉시컬 환경을 검색 범위로 잡고 내부 렉시컬 환경에서 원하는 변수를 찾지 못할 때 검색 범위를 외부 렉시컬 환경으로 확장한다.
  - 전역 렉시컬 환경에 도달할 때까지 변수를 찾지 못하면 엄격 모드에선 에러가, 비 엄격 모드에선 새로운 전역 변수가 만들어지는데 이는 하위 호환성을 위해 남겨진 기능이다.

<br>

### 4) 함수를 반환하는 함수

```javascript
function makeCounter() {
  let count = 0;

  return function([[Environmnet]]) {
    return count++;
  };
}

let counter = makeCounter();

alert(counter()); // 0
```

- 모든 함수는 함수가 생성된 곳의 렉시컬 환경을 기억한다.
- `[[Environment]]` : 함수가 만들어진 곳의 렉시컬 환경에 대한 참조가 저장되는 숨김 프로퍼티. 함수가 생성될 때 딱 한 번 값이 세팅되고 변하지 않는다.
  - `counter.[[Environment]]` : `{count: 0}`이 있는 렉시컬 환경에 대한 참조가 저장된다.

![image-20220821185248319](https://user-images.githubusercontent.com/51310674/185786637-d6007a0d-02d5-46cd-a1f9-68f269a33f96.png)

- 실행 흐름이 중첩 함수의 본문으로 넘어오면 `count` 변수를 자체 렉시컬 환경에서 찾는다. 익명 중첩 함수엔 지역 변수가 없기 때문에 `counter()`의 렉시컬 환경이 참조하는 외부 렉시컬 환경에서 `count`를 찾는다.
- `count++`가 실행되면서 `count` 값이 1증가하는데, 변숫값 개신은 변수가 저장된 렉시컬 환경에서 이뤄진다.

<br>

### 요약

자바스크립트의 함수는 숨김 프로퍼티인 `[[Environment]]`를 이용해 생성된 곳을 기억한다. 함수 본문에선 `[[Environment]]`를 사용해 외부 변수에 접근한다.

<br>

## 4. 가비지 컬렉션

- 함수 호출이 끝나면 함수에 대응하는 렉시컬 환경이 메모리에서 제거되면서 관련 변수를 참조할 수 없다.
- 하지만 중첩함수의 `[[Environment]]` 프로퍼티에 외부 함수 렉시컬 환경에 대한 정보를 저장하면 렉시컬 환경이 메모리에 유지된다.
  - 중첩 함수가 메모리에서 삭제되어야 렉시컬 환경이 메모리에서 제거된다.

```javascript
function f() {
  let value = 123;

  return function() {
    alert(value);
  }
}

// g.[[Environment]]에 f() 호출 시 만들어지는
// 렉시컬 환경 정보가 저장된다.
let g = f(); 

g = null; // 렉시컬 환경도 메모리에서 제거된다.
```

<br>

### 최적화 프로세스

- 함수가 살아있는 동안엔 모든 외부 변수도 메모리에 유지된다.
- 그러나 실제로 자바스크립트 엔진은 변수 사용을 분석하고 외부 변수가 사용되지 않는다고 판단되면 이를 메모리에서 제거해 최적화한다.
- V8 엔진(Chrome, Opera 등)에서는 디버깅 시, 최적화 과정에서 제거된 변수는 사용할 수 없는 부작용이 있다.
