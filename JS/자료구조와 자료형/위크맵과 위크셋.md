# 위크맵과 위크셋



> 출처 - [모던 JS 튜토리얼](****https://ko.javascript.info/****) 을 보고 정리한 글입니다.



<br>



자바스크립트 엔진은 도달 가능한 값을 메모리에 유지한다. 이런 관점에서 `위크맵(WeakMap)`은 일반 `맵`과 달리 키로 쓰인 객체가 가비지 컬렉션의 대상이 된다.

<br>

## 1. 위크맵

`위크맵`의 키는 반드시 객체여야 하고, 원시값은 위크맵의 키가 될 수 없다.

```javascript
let weakMap = new WeakMap();

let obj = {};

weakMap.set(obj, "ok"); // 정상적으로 동작

weakMap.set("test", "Whoops"); // Error: Invalid value used as weak map key
```

<br>

위크맵의 키로 사용된 객체를 참조하는 것이 아무것도 없다면 해당 객체는 메모리와 위크맵에서 자동으로 삭제된다.

```javascript
let john = { name: "John" };

let weakMap = new WeakMap();
weakMap.set(john, "...");

john = null; // 참조를 덮어씀

// john을 나타내는 객체는 메모리에서 지워진다.
```

<br>

`위크맵`은 `맵`과 달리 반복 작업과 `keys()`, `values()`, `entries()` 메서드를 지원하지 않는다. 따라서 위크맵에선 키나 값 전체를 얻는 게 불가능하다.

> **위크맵이 지원하는 메서드**

- `weakMap.get(key)`
- `weakMap.set(key, value)`
- `weakMap.delete(key)`
- `weakMap.has(key)`

가비지 컬렉션이 일어나는 시점은 자바스크립트 엔진이 결정하기 때문에, 가비지 컬렉터가 한번에 메모리를 청소할 수도 있고, 부분 부분 메모리를 청소할 수도 있다. 따라서, 위크맵의 요소 전체를 대상으로하는 메서드는 동작 자체가 불가능하다.

<br>

## 2. 유스 케이스: 추가 데이터

`위크맵`은 부차적인 데이터를 저장할 곳이 필요할 때 사용된다.

서드파티 라이브러리와 같은 **외부 코드에 속한 객체**를 가지고 작업을 할 때, 이 객체에 추가해줄 데이터는 객체가 살아있는 동안에만 유효하다. 따라서 `위크맵`을 사용해줄 수 있다.

`위크맵`에 원하는 데이터를 저장하고, 키로 객체를 사용하게되면 객체가 가비지 컬렉션의 대상이 될 때, 데이터도 함께 사라지게 된다.

<br>

## 3. 유스 케이스: 캐싱

위크맵은 캐싱(caching)이 필요할 때 유용하다.

> 캐싱이란?

시간이 오래 걸리는 작업의 결과를 저장해서 연산 시간과 비용을 절약해주는 기법

<br>

동일한 함수를 여러 번 호출해야 할 때, 최초 호출 시 반환된 값을 어딘가에 저장해 놓았다가 그 다음엔 함수를 호출하는 대신 저장된 값을 사용하는 것이 캐싱의 대표적인 예이다.

<br>

```javascript
// 📁 cache.js
let cache = new Map();

// 연산을 수행하고 그 결과를 맵에 저장
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* 연산 수행 */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}


// 📁 main.js
let obj = {/* ... 객체 ... */};

let result1 = process(obj); // 함수 호출

// 동일한 함수를 두 번째 호출할 땐,
let result2 = process(obj); // 연산을 수행할 필요 없이 맵에 저장된 결과를 가져오면 된다.

// 객체가 쓸모없어지면 아래와 같이 null로 덮어쓴다.
obj = null;

alert(cache.size); // 1 (하지만 객체가 여전히 cache에 남아있어 메모리가 낭비되고 있다.)
```

위와 같은 경우에 `맵`을 `위크맵`으로 교체하면 객체가 메모리에서 삭제됐을 때, 캐시에 저장된 결과 역시 자동으로 삭제된다.

<br>

## 3. 위크셋

`위크셋`은 `셋`과 유사하지만, 객체만 저장할 수 있다는 차이가 있다.

> **위크셋이 지원하는 메서드**

- `weakSet.add()`
- `weakSet.has()`
- `weakSet.delete()`

위크맵과 유사하게 위크셋도 부차적인 데이터를 저장할 때 사용할 수 있다. 하지만, 위크셋엔 위크맵처럼 복잡한 데이터를 저장하지 않고 '예'나 '아니오' 같은 간단한 답변을 얻는 용도로 사용된다.

