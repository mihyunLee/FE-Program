# 프라미스화



> 출처 - [**모던 JS 튜토리얼**](https://ko.javascript.info/)을 보고 정리한 글입니다.



<br>



> **프라미스화(promisification)**
>
> 콜백을 받는 함수를 프라미스를 반환하는 함수로 바꾸는 것

<br>

### 콜백 함수

```javascript
function loadScript(src, callback) {
    let script = document.createElement('script');
    script.src = src;
    
    script.onload = () => callback(null, scrpit);
    script.onerror = () => callback(new Error(`${scr}를 불러오는 도중에 에러가 발생함`));
    
    document.head.append(script);
}

// 사용법
// loadScript('path/script.js', (err, script) => {...})
```

<br>

### 프라미스화

```javascript
let loadScriptPromise = function(src) {
    return new Promise((resolve, reject) => {
        loadScript(src, (err, script) => {
            if(err) reject(err)
            else resolve(script);
        });
    })
}

// 사용법
// loadScriptPromise('path/script.js').then(...)
```

- `loadScriptPromise`는 기존 함수 `loadScript`에 모든 일을 위임한다.

- `loadScript`의 콜백은 스크립트 로딩 상태에 따라 `이행` 혹은 `거부` 상태의 프라미스를 반환한다.

<br>

### 여러 개의 함수 프라미스화 하기

- 여러 개의 함수를 프라미스화 하기 위해서 헬퍼 함수 만들기
- 프라미스화를 적용할 함수 `f`를 받고 래퍼 함수를 반환하는 함수 `promisify(f)`

```javascript
function promisify(f){
    return function (...args) { // 래퍼 함수를 반환함
        return new Promise((resolve, reject) => {
            function callback(err, result) { // f에 사용할 커스텀 콜백
                if(err) {
                    reject(err);
                } else {
                    resolve(result);
                }
            }
            
            args.push(callback); // 위에서 만든 커스텀 콜백을 함수 f의 인수 끝에 추가
            f.call(this, ...args) // 기존 함수 호출
        });
    };
};

// 사용법 :
// let loadScriptPromise = promisify(loadScript);
// loadScriptPromise(...).then(...);
```

- 함수 `f`가 두 개를 초과하는 인수를 가진 콜백,  `callback(err, res1, res2, ...)`을 받는 경우를 대비하여 함수를 수정해야 한다.

<br>

### 여러 개의 함수 프라미스화 하기 (Upgrade)

```javascript
// 콜백의 성공 결과를 담은 배열을 얻게 해주는 promisify(f, true)
function promisify(f, manyArgs = false) {
    return function (...args) {
        return new Promise((resolve, reject) => {
            function callback(err, ...results) { // f에 사용할 커스텀 콜백
                if (err) {
                    reject(err);
                } else {
                    // manyArgs가 구체적으로 명시되었다면, 콜백의 성공 케이스와 함께 이행 상태가 된다.
                    resolve(manyArgs ? results : results[0]);
                }
            }
            args.push(callback);
            f.call(this, ...args);
        });
    };
};

// 사용법:
// f = promisify(f, true);
// f(...).then(arrayOfResults => ..., err => ...)
```

- `promisify(f, true)` 형태로 호출하면, 프라미스 결과는 콜백의 성공 케이스(`results`)를 담은 배열, `[res1, res2, ...]`이 된다.
- `callback(result)` 같이 `err`이 없는 형태나 이 외의 이색적인 콜백의 경우에는 헬퍼 함수를 사용하지 않고 직접 프라미스화 하면 된다.