# 프라미스와 에러 핸들링



> 출처 - [**모던 JS 튜토리얼**](https://ko.javascript.info/)을 보고 정리한 글입니다.



<br>



프라미스가 거부되면 제어 흐름이 제일 가까운 rejection 핸들러로 넘어가기 때문에 **프라미스 체인**을 사용하여 에러를 쉽게 처리할 수 있다.

<br>

## 1. `.catch`로 에러 처리하기

```javascript
fetch('https://no-such-server.blabla') // 존재하지 않는 주소
	.then(response => response.json())
	.catch(err => alert(err)) // TypeERror: Failed to fetch
```

- `.catch`는 첫 번째 핸들러일 필요가 없고 하나 혹은 여러 개의 `.then` 뒤에 올 수 있다.
- 네트워크 문제, 잘못된 형식의 JSON 등으로 여러 개의 프라미스 중 하나라도 거부되면 `.catch`에서 에러를 잡게 된다.

<br>

## 2. 암시적 try...catch

프라미스 `executor`와 프라미스 핸들러 코드 주위엔 보이지 않는 `try..catch`가 있다.

예외가 발생하면 암시적 `try..catch`에서 예외를 잡고 이를 `reject`처럼 다룬다.

### 예시

```javascript
// (1)
new Promise((resolve, reject) => {
    throw new Error('에러 발생');
}).catch(alert); // Error: 에러 발생

// (2)
new Promise((resolve, reject) => {
    reject(new Error('에러 발생'));
}).catch(alert); // Error: 에러 발생
```

위의 두 개의 예시는 동일하게 동작한다. `executor` 주위의 암시적 `try..catch`는 스스로 에러를 잡고, 에러를 거부상태의 프라미스로 변경시킨다.

`executor` 함수뿐만 아니라 핸들러에서도 발생하여 `.then` 핸들러 안에서 `throw`를 사용해 에러를 던지면, 이 자체가 거부된 프라미스를 의미하게 된다.

<br>

## 3. 다시 던지기

- `try..catch`에서는 에러를 분석하고, 처리할 수 없는 에러라 판단되면 에러를 다시 던질 때가 있다. 프라미스에서도 유사한 일을 할 수 있다.
- `.catch` 블록이 정상적으로 종료되면 다음 성공 핸들러 `.then`이 호출된다.

```javascript
// 실행 순서: catch -> catch
new Promise((resolve, reject) => {

  throw new Error("에러 발생!");

}).catch(function(error) {

  if (error instanceof URIError) {
    // 에러 처리
  } else {
    alert("처리할 수 없는 에러"); // 실행됨

    throw error; // 에러 다시 던지기
  }

}).then(function() {
  /* 여기는 실행되지 않는다 */
}).catch(error => {

  alert(`알 수 없는 에러가 발생함: ${error}`); // 실행됨

});
```

<br>

## 4. 처리되지 못한 거부

`.catch`가 없어 에러가 처리되지 못하면 스크립트가 죽고 콘솔 창에 메시지가 출력된다.

자바스크립트 엔진은 프라미스 거부를 추적하다가 처리하지 못했을 경우 전역 에러를 생성한다.

브라우저 환경에선 이런 에러를 `unhandledrejection` 이벤트로 처리할 수 있다.

```javascript
window.addEventListener('unhandledrejection', function(event){
    alert(event.promise); // [object Promise] - 에러를 생성하는 프라미스
    alert(event.reanson); // Error: 에러 발생! - 처리하지 못한 에러 객체
})
```

> **unhandledrejection 이벤트**
>
> 전역 범위 개체에서 발생하는 HTML 명세서에 정의된 표준 이벤트이다.
>
> 브라우저 환경에서 에러가 발생했을 때 `.catch`가 없으면 `unhandlerejection` 핸들러가 트리거 된다. 
>
> `unhandledrejection` 핸들러는 에러 정보가 담긴 `event` 객체를 받기 때문에 이 핸들러 안에서 원하는 작업을 할 수 있다.

